{% extends "sistema/layout.html" %}


{% block contenido %}
<style>
    #leyenda {
        font-family: Arial, sans-serif;
    }

    .circulo {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 5px;
    }

    #amarillo {
        background-color: var(--yellow);
    }

    #verde {
        background-color: var(--light-green);
    }

    #rojo {
        background-color: var(--red);
    }

    #programado {
        background-color: var(--blue);
    }
</style>
<div class="container-fluid">
    <div class="col-lg d-flex p-0">
        <div class="card w-100 p-3">
            <div class="table-calendar">

                <div class="order ">
                    <div class="row mb-3">

                        <div class="col filter-container">
                            <i class='bx bxs-calendar' style="color: #0D6EFD; font-size: 25px;" id="Fecha"></i>
                            <input type="hidden" placeholder="Pick date rage" id="start" value="" />
                            <input type="hidden" placeholder="Pick date rage" id="2" value="" />
                            <button class="btn btn-primary d-none" id="applyFilter">Aplicar Filtro</button>

                        </div>
                    </div>

                    <div id="calendario-cliente"></div>
                </div>
            </div>

        </div>
    </div>

</div>
<!-- MODALES -->

<div id="agendar-modal"></div>
<input id="agregar" type="hidden" data-bs-toggle="modal" data-bs-target="#agendarConsulta">

<div id="detalle-modal"></div>
<input id="detalle" type="hidden" data-bs-toggle="modal" data-bs-target="#detalleCita">





<div class="modal fade" id="agregarCliente" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
    aria-labelledby="staticBackdropLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalToggleLabel2">Agregar Cliente</h5>
                <!-- <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button> -->
            </div>
            <div class="modal-body">
                <div class="row mt-3">
                    <div class="col">
                        <div class="form-group" id="camionModal">
                            <label for="txtPlacaV" class=" form-label">Nombres</label>

                            <input type="text" id="nombreCliente" class="form-control">
                        </div>
                    </div>
                    <div class="col">
                        <div class="form-group" id="camionModal">
                            <label for="txtPlacaV" class=" form-label">Apellidos</label>

                            <input type="text" id="apellidoCliente" class="form-control">
                        </div>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col">
                        <div class="form-group" id="camionModal">
                            <label for="txtPlacaV" class=" form-label">Correo</label>

                            <input type="text" id="nombreCliente" class="form-control">
                        </div>
                    </div>
                    <div class="col">
                        <div class="form-group" id="camionModal">
                            <label for="txtPlacaV" class=" form-label">Teléfono</label>

                            <input type="text" id="apellidoCliente" class="form-control">
                        </div>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col">
                        <div class="form-group" id="camionModal">
                            <label for="txtPlacaV" class=" form-label">Dirección</label>

                            <textarea name="" class="form-control" id=""></textarea>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-target="#capturarPeso" id="regresar" data-bs-toggle="modal"
                    data-bs-dismiss="modal">Regresar</button>
                <button class="btn btn-primary" onclick="NuevoConductor()">Guardar</button>
            </div>
        </div>
    </div>
</div>


<div class="modal fade" id="agregarMascota" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
    aria-labelledby="staticBackdropLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalToggleLabel2">Agregar Mascota</h5>
                <!-- <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button> -->
            </div>
            <div class="modal-body">
                <div class="row mt-3">
                    <div class="col-lg-12">
                        <div class="form-group" id="camionModal">
                            <label for="txtPlacaV" class=" form-label">Placa</label>

                            <input type="text" id="PlacaNueva" class="form-control">
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-target="#capturarPeso" id="regresar1" data-bs-toggle="modal"
                    data-bs-dismiss="modal">Regresar</button>
                <button class="btn btn-primary" onclick="NuevaPlaca()">Guardar</button>
            </div>
        </div>
    </div>
</div>
<!-- FIN DEL MODAL -->
<!-- FIN DE MODALES -->
<script>
    var consultas = new Array()
    var ret = new Array()
    function aleatorio(inferior, superior) {
        numPosibilidades = superior - inferior
        aleat = Math.random() * numPosibilidades
        aleat = Math.floor(aleat)
        return parseInt(inferior) + aleat
    }
    function color() {
        hexadecimal = new Array("0", "1", "2", "3", "4", "5", "6", "7", "8", "9", "A", "B", "C", "D", "E", "F")
        color_aleatorio = "#";
        for (i = 0; i < 6; i++) {
            posarray = aleatorio(0, hexadecimal.length)
            color_aleatorio += hexadecimal[posarray]
        }
        console.log(color_aleatorio)
        return color_aleatorio
    }
    function Agendar(fechaSeleccionada, eventosDelDia) {
        var horasOcupadas = eventosDelDia.map(function (evento) {
            return evento.start.toISOString().split('T')[1].substring(0, 5); // Extrae HH:MM
        });

        $.ajax({
            url: "{{ url_for('sistema.modalAgendar') }}",
            type: "POST",
            data: {
                fecha: fechaSeleccionada,
            },
            success: function (response) {
                $('#agendar-modal').html(response);
                $('#agendar-modal').append(response.htmlresponse);
                $('#agregar').click();
            },
            error: function (error) {
                console.error("Error en la solicitud AJAX:", error);
            },
        });
    }
    function Detalles(id) {


        $.ajax({
            url: "{{ url_for('sistema.modalDetalleCita') }}",
            type: "POST",
            data: {
                num: id,
            },
            success: function (response) {
                $('#detalle-modal').html(response);
                $('#detalle-modal').append(response.htmlresponse);
                $('#detalle').click();
            },
            error: function (error) {
                console.error("Error en la solicitud AJAX:", error);
            },
        });
    }
    var calFuera;

   function HorasDisponiblesReagendar(fecha, $select) {
  $.ajax({
    url: "{{ url_for('sistema.horasDisponibles') }}",
    type: "POST",
    dataType: "json",          // <- asegura JSON
    data: { fecha },
    beforeSend: () => {
      $select.html('<option value="" disabled selected>Cargando...</option>');
    },
    success: function (response) {
      $select.empty().append('<option value="" disabled selected>Seleccione una hora</option>');
      if (response && Array.isArray(response.horas_disponibles) && response.horas_disponibles.length) {
        response.horas_disponibles.forEach(function (hora) {
          $select.append('<option value="' + hora + '">' + hora + '</option>');
        });
      } else {
        $select.append('<option value="" disabled>(Sin horarios disponibles)</option>');
      }
    },
    error: function (error) {
      console.error("Error en la solicitud AJAX:", error);
      $select.empty().append('<option value="" disabled>(Error al cargar horas)</option>');
    },
  });
}


    function cale() {
  const calendarEl1 = document.getElementById('calendario-cliente');

  const calendar1 = new FullCalendar.Calendar(calendarEl1, {
    buttonText: {
      prevYear: 'prev year', nextYear: 'next year', year: 'year',
      today: 'Hoy', month: 'Mes', day: 'Día', list: 'Lista',
    },
    locale: 'es',
    headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,timeGridDay' },
    hiddenDays: [0],            // Oculta domingos
    events: consultas,          // Tus eventos
    editable: true,
    droppable: true,
    eventTimeFormat: { hour: '2-digit', minute: '2-digit', meridiem: false },
    views: {
      dayGridMonth: { displayEventTime: true },
      timeGridDay: { displayEventTime: true }
    },

    dateClick: function (info) {
      const eventsOnSelectedDate = calendar1.getEvents().filter(function (evento) {
        const eventoDate = evento.start.toISOString().split('T')[0];
        return eventoDate === info.dateStr;
      });
      if (eventsOnSelectedDate.length < 5) {
        Agendar(info.dateStr, eventsOnSelectedDate);
      } else {
        console.log("No se pueden agendar más citas en esta fecha.");
      }
    },

    eventClick: function (info) {
      // Mejor llama a tu función de detalle si la tienes
      const eventId = info.event.id;
      if (typeof Detalles === 'function') {
        Detalles(eventId);
        return;
      }
      // Fallback seguro (sin eventDetails indefinido)
      Swal.fire({
        title: 'Detalles de la cita',
        html: `
          <p><strong>Título:</strong> ${info.event.title || '-'}</p>
          <p><strong>Fecha:</strong> ${info.event.start?.toLocaleDateString() || '-'}</p>
          <p><strong>Hora:</strong> ${info.event.start?.toLocaleTimeString() || '-'}</p>
        `,
        icon: 'info',
        showCloseButton: true,
      });
    },

    eventDrop: function (info) {
      const nuevaFecha = info.event.start;
      const eventId = info.event.id;

      const anio = nuevaFecha.getFullYear();
      const mes  = (nuevaFecha.getMonth() + 1).toString().padStart(2, '0');
      const dia  = nuevaFecha.getDate().toString().padStart(2, '0');
      const formatoFecha = `${anio}-${mes}-${dia}`;

      Swal.fire({
        title: "Reagendar",
        html: `
          <div style="text-align:left">
            <label for="hora-reagendar" class="form-label">Elija la hora</label>
            <select id="hora-reagendar" class="form-control"></select>
          </div>
        `,
        didOpen: () => {
          const $select = $('#hora-reagendar', Swal.getHtmlContainer());
          HorasDisponiblesReagendar(formatoFecha, $select);
        },
        preConfirm: () => {
          const $select = $('#hora-reagendar', Swal.getHtmlContainer());
          const value = $select.val();
          if (!value) {
            Swal.showValidationMessage('Debe seleccionar una hora');
            return false;
          }
          return value; // se pasa a result.value
        },
        showCancelButton: true,
        confirmButtonText: 'Guardar',
        cancelButtonText: 'Cancelar'
      }).then((result) => {
        if (result.isConfirmed) {
          const hora = result.value;
          $.ajax({
            url: "{{ url_for('sistema.reAgendar') }}",
            type: "POST",
            dataType: "json",
            data: { id: eventId, hora, fecha: formatoFecha },
            success: function () {
              Swal.fire({ icon: 'success', title: 'Éxito', text: '¡Su cita se reagendó!' })
                .then(() => { cargareventos(); });
            },
            error: function (error) {
              console.error(error);
              Swal.fire({ icon: 'error', title: 'Error', text: 'No se pudo reagendar la cita' });
              info.revert(); // Revertir al fallar
            },
          });
        } else {
          info.revert(); // Revertir si cancelan
        }
      });
    },

    eventResize: function (info) {
      console.log("Evento redimensionado:", info.event.start, "hasta", info.event.end);
      // Aquí actualizar la duración si aplica
    }
  });

  // Renderiza UNA sola vez
  calFuera = calendar1;
  calendar1.render();

  // Filtros
  document.getElementById('applyFilter')?.addEventListener('click', function () {
    applyFilter(calendar1);
  });
}

    $(document).ready(function () {

        cargareventos();

    });

    function cargareventos() {
        $.ajax({
            url: "{{ url_for('sistema.traerCitasSistema') }}",
            type: "GET",
            data: {

            },
            success: function (response) {
                // $('#pendientes').html(response);
                // $('#pendientes').append(response.htmlresponse);
                var json = JSON.parse(response.replace(/'/g, '"'));


                var elementos = $('#pendientes .extraer')

                $.each(json, (index, evento) => {
                    var color;
                    console.log(evento.estado)
                    if (evento.estado === 'AGENDADO') {
                        color = 'var(--bs-info)';  // Verde para completados
                    } else if ((evento.estado == 'COMPLETADOS')) {
                        color = '#0da10d';
                    } else if ((evento.estado == 'RETRASADO')) {
                        color = 'var(--red)'; // Otro color por defecto
                    } else if ((evento.estado == 'PLANIFICADO')) {
                        color = 'var(--red)'; // Otro color por defecto
                    }
                    // var fechaFinActual = new Date();
                    // fechaFinActual.setDate(fechaFinActual.getDate() + 1);

                    // Actualizar la propiedad fechafin con la nueva fecha

                    consultas.push({
                        id: evento.numero,
                        title: evento.cliente,
                        start: evento.fecha,
                        end: evento.fechafin,
                        backgroundColor: color,
                        borderColor: '#130f40'
                    });

                });
                console.log(JSON.stringify(consultas))
                ret = JSON.stringify(consultas)
                cale();
                consultas = []; // Se crea un nuevo arreglo vacío, reemplazando el anterior
                ret = []; // Se crea un nuevo arreglo vacío, reemplazando el anterior

            },
            error: function (error) {
                // console.log(error);
            },
        });

    }
</script>

{% endblock %}